From ffb473c5361df05d9d93fa519d8ecb3b079b20b5 Mon Sep 17 00:00:00 2001
From: YANXIAOXIH <yanxiaoxi@live.com>
Date: Wed, 17 Sep 2025 16:13:06 +0800
Subject: [PATCH] dts: rk3588: Add SPI LCD overlay and driver support for
 LemonPi

This patch introduces support for a common SPI-based LCD module (using the ST7789V controller) on the rk3588-lemonpi board via a device tree overlay.

The new  overlay accomplishes the following:
- Enables the SPI0 bus (spi0m1).
- Defines a node for a 172x320 ST7789V LCD panel, configuring its reset and D/C GPIOs.
- Configures PWM13 to provide backlight control for the display.
- Sets up the necessary pinmuxing for all related SPI, GPIO, and PWM pins.
- Additionally includes a PWM-based fan control node for thermal management.

To ensure correct image positioning on displays where the controller's resolution differs from the panel's (e.g., a 240x320 controller on a 172x320 panel), the  driver has been enhanced:
- It now parses  and  properties from the device tree.
- A new  function applies these offsets when setting the display window, allowing for precise image alignment.

Finally, the new overlay is added to the overlay Makefile to ensure it is built as part of the kernel image.

Signed-off-by: YANXIAOXIH <yanxiaoxi@live.com>
---
 arch/arm64/boot/dts/rockchip/overlay/Makefile |   1 +
 .../rockchip/overlay/rk3588-lemonpi-spi.dts   | 113 ++++++++++++++++++
 drivers/staging/fbtft/fb_st7789v.c            |  43 +++++++
 3 files changed, 157 insertions(+)
 create mode 100644 arch/arm64/boot/dts/rockchip/overlay/rk3588-lemonpi-spi.dts

diff --git a/arch/arm64/boot/dts/rockchip/overlay/Makefile b/arch/arm64/boot/dts/rockchip/overlay/Makefile
index 644050ebb..cfa3976c2 100644
--- a/arch/arm64/boot/dts/rockchip/overlay/Makefile
+++ b/arch/arm64/boot/dts/rockchip/overlay/Makefile
@@ -184,6 +184,7 @@ dtbo-$(CONFIG_ARCH_ROCKCHIP) += \
 	rk3588-spi4-m1-cs0-spidev.dtbo \
 	rk3588-spi4-m1-cs1-spidev.dtbo \
 	rk3588-spi4-m2-cs0-spidev.dtbo \
+	rk3588-lemonpi-spi.dtbo \
 	rk3588-uart0-m2.dtbo \
 	rk3588-uart1-m1.dtbo \
 	rk3588-uart2-m0.dtbo \
diff --git a/arch/arm64/boot/dts/rockchip/overlay/rk3588-lemonpi-spi.dts b/arch/arm64/boot/dts/rockchip/overlay/rk3588-lemonpi-spi.dts
new file mode 100644
index 000000000..c82031e2b
--- /dev/null
+++ b/arch/arm64/boot/dts/rockchip/overlay/rk3588-lemonpi-spi.dts
@@ -0,0 +1,113 @@
+// SPDX-License-Identifier: (GPL-2.0+ OR MIT)
+/dts-v1/;
+/plugin/;
+
+#include <dt-bindings/pinctrl/rockchip.h>
+#include <dt-bindings/gpio/gpio.h>
+
+/ {
+    fragment@0 {
+        target = <&spi0>;
+        __overlay__ {
+            status = "okay";
+            pinctrl-names = "default";
+            pinctrl-0 = <&spi0m1_clk_pins>, <&spi0m1_mosi_pins>, <&spi0m1_cs0_pins>;
+
+            st7789_panel: panel@0 {
+                compatible = "sitronix,st7789v";
+                reg = <0>;
+                spi-max-frequency = <48000000>;
+                pinctrl-names = "default";
+                pinctrl-0 = <&st7789_dc_pins>, <&st7789_reset_pins>;
+                reset-gpios = <&gpio4 RK_PB0 GPIO_ACTIVE_LOW>;
+                dc-gpios = <&gpio4 RK_PA0 GPIO_ACTIVE_HIGH>;
+                backlight = <&st7789_backlight>;
+                width = <172>;
+                height = <320>;
+                rotate = <90>;
+                fps = <30>;
+                buswidth = <8>;
+                x-offset = <0>;
+                y-offset = <34>; 
+                status = "okay";
+            };
+        };
+    };
+
+    fragment@1 {
+        target-path = "/";
+        __overlay__ {
+            st7789_backlight: st7789-backlight {
+                compatible = "pwm-backlight";
+                pwms = <&pwm13 0 100000 0>;
+                brightness-levels = <0 4 8 16 32 64 128 255>;
+                default-brightness-level = <6>;
+                power-supply = <&vcc3v3_sys>;
+                status = "okay";
+            };
+        };
+    };
+
+    fragment@2 {
+        target = <&pwm13>;
+        __overlay__ {
+            pinctrl-names = "default";
+            pinctrl-0 = <&pwm13_m1_pins>;
+            status = "okay";
+        };
+    };
+
+    fragment@3 {
+        target = <&pinctrl>;
+        __overlay__ {
+            /* SPI0 M1 Pins */
+            spi0-m1-pins  {
+                spi0m1_clk_pins: spi0m1-clk-pins {
+                    rockchip,pins = <4 RK_PA2 8 &pcfg_pull_up_drv_level_1>;
+                };
+                spi0m1_mosi_pins: spi0m1-mosi-pins {
+                    rockchip,pins = <4 RK_PA1 8 &pcfg_pull_up_drv_level_1>;
+                };
+                spi0m1_cs0_pins: spi0m1-cs0-pin {
+                    rockchip,pins = <4 RK_PB2 8 &pcfg_pull_up_drv_level_1>;
+                };
+            };
+
+            /* ST7789 GPIO Pins */
+            st7789-pins {
+                st7789_dc_pins: st7789-dc-pins {
+                    rockchip,pins = <4 RK_PA0 RK_FUNC_GPIO &pcfg_pull_none>;
+                };
+                st7789_reset_pins: st7789-reset-pins {
+                    rockchip,pins = <4 RK_PB0 RK_FUNC_GPIO &pcfg_pull_none>;
+                };
+            };
+
+            /* PWM13 M1 Pin */
+            pwm13-m1 {
+                pwm13_m1_pins: pwm13-m1-pins {
+                    rockchip,pins = <4 RK_PB6 11 &pcfg_pull_none>;
+                };
+            };
+        };
+    };
+
+	/* PWM cooling fan */
+    fragment@4 {
+        target-path = "/";
+        __overlay__ {
+            fan: pwm-fan {
+                compatible = "pwm-fan";
+                #cooling-cells = <2>;
+                pwms = <&pwm4 0 5000 0>;
+                cooling-levels = <0 100 150 200 255>;
+                rockchip,temp-trips = <
+                    45000	1
+                    55000	2
+                    60000	3
+                    65000	4
+                >;
+            };
+        };
+    };
+};
\ No newline at end of file
diff --git a/drivers/staging/fbtft/fb_st7789v.c b/drivers/staging/fbtft/fb_st7789v.c
index 861a15414..d2d7d6046 100644
--- a/drivers/staging/fbtft/fb_st7789v.c
+++ b/drivers/staging/fbtft/fb_st7789v.c
@@ -13,6 +13,7 @@
 #include <linux/interrupt.h>
 #include <linux/completion.h>
 #include <linux/module.h>
+#include <linux/property.h>
 
 #include <video/mipi_display.h>
 
@@ -76,6 +77,30 @@ enum st7789v_command {
 static struct completion panel_te; /* completion for panel TE line */
 static int irq_te; /* Linux IRQ for LCD TE line */
 
+struct st7789v_par {
+	u32 x_offset;
+	u32 y_offset;
+};
+
+static void set_addr_win_flexible(struct fbtft_par *par, int xs, int ys, int xe, int ye)
+{
+	struct st7789v_par *st_par = dev_get_drvdata(par->info->device);
+
+	/* Apply the offsets read from the device tree */
+	xs += st_par->x_offset;
+	xe += st_par->x_offset;
+	ys += st_par->y_offset;
+	ye += st_par->y_offset;
+
+	write_reg(par, MIPI_DCS_SET_COLUMN_ADDRESS,
+		  (xs >> 8) & 0xFF, xs & 0xFF, (xe >> 8) & 0xFF, xe & 0xFF);
+
+	write_reg(par, MIPI_DCS_SET_PAGE_ADDRESS,
+		  (ys >> 8) & 0xFF, ys & 0xFF, (ye >> 8) & 0xFF, ye & 0xFF);
+
+	write_reg(par, MIPI_DCS_WRITE_MEMORY_START);
+}
+
 static irqreturn_t panel_te_handler(int irq, void *data)
 {
 	complete(&panel_te);
@@ -142,8 +167,25 @@ static int init_tearing_effect_line(struct fbtft_par *par)
  */
 static int init_display(struct fbtft_par *par)
 {
+	struct device *dev = par->info->device;
+	struct st7789v_par *st_par;
 	int rc;
 
+	/* Allocate and initialize our private data structure */
+	st_par = devm_kzalloc(dev, sizeof(struct st7789v_par), GFP_KERNEL);
+	if (!st_par)
+		return -ENOMEM;
+
+	/* Read optional offset properties from the device tree */
+	device_property_read_u32(dev, "x-offset", &st_par->x_offset);
+	device_property_read_u32(dev, "y-offset", &st_par->y_offset);
+
+	/* Attach our private data to the device for later retrieval */
+	dev_set_drvdata(dev, st_par);
+
+	dev_info(dev, "display offsets: x=%u, y=%u\n", st_par->x_offset, st_par->y_offset);
+
+
 	par->fbtftops.reset(par);
 
 	rc = init_tearing_effect_line(par);
@@ -379,6 +421,7 @@ static struct fbtft_display display = {
 		.set_var = set_var,
 		.set_gamma = set_gamma,
 		.blank = blank,
+		.set_addr_win = set_addr_win_flexible,
 	},
 };
 
-- 
2.39.5

